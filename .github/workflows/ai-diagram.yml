name: AI 自動分析架構並繪圖

on:
  workflow_dispatch: # 手動觸發
  push:
    branches: [ main ]
    paths:
      - 'src/**' # 當原始碼變動時執行

permissions:
  contents: write
  # 2026 年新功能：允許 Action 直接使用 Copilot 權限
  id-token: write 

jobs:
  ai-arch-gen:
    runs-on: ubuntu-latest
    steps:
      - name: Check MODELS_TOKEN presence
        env:
          MODELS_TOKEN: ${{ secrets.MODEL_TOKEN }}
        run: |
          if [ -z "$MODELS_TOKEN" ]; then
            echo "MODELS_TOKEN missing"
            exit 1
          else
            echo "MODELS_TOKEN is set"
          fi
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests

      - name: AI 分析代碼生成 Mermaid 檔
        env:
          # 直接使用內建的 GITHUB_TOKEN (需確認 Repo 設定已開啟 Copilot 存取權)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODELS_TOKEN: ${{ secrets.MODEL_TOKEN }} # 從 Secret 讀取並轉為環境變數
        run: python .github/scripts/generate_architecture.py

      - name: Generate Mermaid Diagram
        id: mermaid
        uses: imjohnbo/action-to-mermaid@v1.1.0

      - name: Output Mermaid Diagram
        env:
          MERMAID: ${{ steps.mermaid.outputs.mermaid }}
        run: |
          echo "$MERMAID"

      - name: Save Mermaid Diagram to File
        run: |
          echo "$MERMAID" > docs/architecture.mmd

      - name: Setup mermaid-cli
        uses: AnimMouse/setup-mermaid-cli@v1
        with:
          version: '11.4.0'

      - name: Convert Mermaid to SVG
        run: mmdc -i docs/architecture.mmd -o docs/architecture.svg

      - name: 提交並推送更新
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/architecture.mmd docs/architecture.svg
          git commit -m "docs: AI 自動更新架構圖 [skip ci]" || echo "No changes"
          git push
